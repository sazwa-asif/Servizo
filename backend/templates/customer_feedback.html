{% extends "base.html" %}
{% block content %}
<div class="container my-5">
  <h2 class="fw-bold mb-4" style="color: #0B506D;">Give Feedback</h2>

  {% if completed_jobs %}
  <div class="container">
    <div class="row row-cols-1 row-cols-md-2 g-4">
      {% for job in completed_jobs %}
      <div class="col">
        <div class="card shadow-sm border-0 rounded-4 p-3 h-100">
          <div class="d-flex justify-content-between">
            <div>
              <h5 class="fw-bold mb-1" style="color: #0B506D;">{{ job.ServiceName }}</h5>
              <p class="text-muted mb-1"><i class="bi bi-person"></i> {{ job.ProviderName }}</p>
              <p class="small mb-1 text-secondary">
                <i class="bi bi-calendar"></i>
                {{ job.BookingDate.strftime('%d %b') if job.BookingDate else '—' }},
                {{ job.FormattedTime if job.FormattedTime else '—' }}


              </p>
            </div>
            <div class="text-end">
              <h6 class="fw-bold" style="color: #0B506D;">Rs. {{ job.OfferedPrice }}</h6>

              {% if not job.FeedbackGiven %}
              <button
                class="btn btn-sm mt-2"
                style="background-color: #0B506D; border-color: #0B506D; color: white;"
                data-bs-toggle="modal"
                data-bs-target="#feedbackModal"
                data-provider-id="{{ job.ServiceProviderID }}"
                data-provider-name="{{ job.ProviderName }}"
                data-booking-id="{{ job.BookingID }}">
                Give Feedback
              </button>
              {% else %}
              <button class="btn btn-secondary btn-sm mt-2" disabled>
                Feedback Given
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
  <div class="alert alert-info mt-4">You have no completed jobs yet.</div>
  {% endif %}
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <form method="POST">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" style="color: white;" id="feedbackModalLabel">Give Feedback</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="provider_id" id="provider_id">
          <input type="hidden" name="booking_id" id="booking_id">

          <div class="mb-3">
            <label class="form-label fw-semibold" style="color: #212529;">Provider</label>
            <input type="text" id="provider_name" class="form-control bg-light" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold" style="color: #212529;">Rating</label>
            <div class="rating">
              {% for i in range(1, 6) %}
              <input type="radio" name="rating" id="star{{ i }}" value="{{ i }}" required>
              <label for="star{{ i }}">⭐</label>
              {% endfor %}
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold" style="color: #212529;">Feedback</label>
            <textarea name="feedback" class="form-control" rows="3" placeholder="Write your feedback..." required></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn w-100" style="background-color: #0B506D; border-color: #0B506D; color: white;">Submit Feedback</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript to populate modal -->
<script>
const feedbackModal = document.getElementById('feedbackModal');
feedbackModal.addEventListener('show.bs.modal', event => {
  const button = event.relatedTarget;
  const providerId = button.getAttribute('data-provider-id');
  const providerName = button.getAttribute('data-provider-name');
  const bookingId = button.getAttribute('data-booking-id');

  document.getElementById('provider_id').value = providerId;
  document.getElementById('provider_name').value = providerName;
  document.getElementById('booking_id').value = bookingId;
});
</script>
{% endblock %}